<html>
    <head>
        <title>... Testing Telaen v2.x installation ...</title>
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    </head>

    <body>
        <font face="Arial" size="+1">

<?php
        ini_set('display_errors', 0);
        error_reporting(E_ALL);
        define('I_AM_TELAEN', 'check_install.php');

        chdir('../'); // So the include works
?>

        <h1>Intro</h1>
        <strong>This script will test your installation and configuration of Telaen v2.x and try to give you a solution.</strong><br/>

        <h2>Checking PHP version:</h2>
<?php
        $phpver = phpversion();
        $phpver = doubleval($phpver[0] . '.' . $phpver[2]);
        if ((double) $phpver < 5.4) {
            echo('<font color=red><strong>!! FAILED !!</strong></font>Talaen requires at least version 5.4.x; you are running {$phpver} <br/>');
            $error = true;
        } else
            echo('<font color=green><strong>PASSED</strong></font> (Running PHP version ' . $phpver . ') <br/>');
?>
        <hr>
        <h2>Checking for old configuration file(s)</h2>

        Older versions of Telaen used 3 separate files and a different configuration method.
        Checking if the old configs are still around:<br/>

<?php
        $has_old_files = false;
        $old_files = Array();
        foreach (Array("config.languages.php", "config.php", "config.security.php") as $i) {
            if (file_exists('./inc/config/' . $i)) {
                @include "./inc/config/$i";
                $has_old_files = true;
                $old_files[] = $i;
            }
        }
        $oconfig = $GLOBALS;
        unset($oconfig['has_old_files']);
        unset($oconfig['old_files']);
        unset($oconfig['phpver']);

        if ($has_old_files) {
            echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font><br/>I see the following old config files:</br>');
            foreach ($old_files as $i) {
                echo('<font face="Courier New" color=Gray>&nbsp;&nbsp;&nbsp;&nbsp;' . $i . '</font><br/>');
            }
            echo('<br/>Done<br/>');
             echo('These should be deleted!<br/>');
           $warn = true;
        } else
            echo('<font color=green><strong>PASSED</strong></font><br/>');
?>
        <hr>
        <h2>Checking for old files:</h2>
        With the upgrade to version 2.x, some files are no longer required and
        should be deleted. Checking for these now:<br/>

<?php
        $has_old_files = false;
        $old_files = Array();

        foreach (Array('inc/lib.php', 'langs/bg.txt', 'langs/en_UK.txt', 'langs/is.txt', 'langs/nl.txt', 'langs/ru.txt',
        'langs/ch_big5.txt', 'langs/es.txt', 'langs/it.txt', 'langs/ru_KOI.txt',
        'langs/cz_iso.txt', 'langs/fr.txt', 'langs/ko.txt', 'langs/pl.txt', 'langs/se.txt',
        'langs/de.txt', 'langs/he.txt', 'langs/ms.txt', 'langs/pt_BR.txt', 'langs/th.txt',
        'langs/dk.txt', 'langs/hu.txt', 'langs/nb.txt', 'langs/ro.txt', 'langs/tr.txt') as $i) {
            if (file_exists('./' . $i)) {
                $has_old_files = true;
                $old_files[] = $i;
            }
        }

        if ($has_old_files) {
            echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font><br/>I see the following old files:</br>');
            foreach ($old_files as $i) {
                echo('<font face="Courier New" color=Gray>&nbsp;&nbsp;&nbsp;&nbsp;' . $i . '</font><br/>');
            }
            echo('<br/>Done<br/>');
            echo('These should be deleted!<br/>');
            $warn = true;
        } else
            echo('<font color=green><strong>PASSED</strong></font><br/>');
?>
        <hr>
        <h2>Testing <font face="Courier New" color=Gray>inc/config/configv2.php</font></h2>
        <em>if the script stops here, there are parsing problems with your file; try getting a fresh copy and re-editing it</em>)<br/>

        Telaen configuration is located in the <font face="Courier New" color=Gray>./inc/config</font> folder
        in <font face="Courier New" color=Gray>configv2.php.default</font> and
        <font face="Courier New" color=Gray>configv2.php</font>. Checking now:<br/>

<?php
@include './inc/config/configv2.php';
if (!isset($config) || !is_array($config)) {
    echo('<font color=red><strong>!! FAILED !!</strong></font><br/>I don\'t see, or cannot read, your <font face="Courier New" color=Gray>configv2.php</font> file<br/>');
    //
    // Try to create one for them...
    //
    $keep = array('appversion', 'appname', 'themes', 'languages', 'default_theme', 'default_language');
    $config = array();
    include './inc/config/configv2.php.default';
    if (count($config) > 0) {
        echo "Try";
        foreach ($config as $key => $value) {
            if (!in_array($key, $keep))
                $config[$key] = ${$key};
        }
        $config['capa_override']['PIPELINING'] = $oconfig['mail_use_pipelining'];
        $config['capa_override']['ATOP'] = $oconfig['mail_use_atop'];
        $config['capa_override']['UIDL'] = $oconfig['mail_use_uidl'];
        $config['capa_override']['APOP'] = $oconfig['mail_use_apop'];
        $config['SMARTY_DIR'] = SMARTY_DIR;
        $fp = @fopen('/tmp/configv2.php.new', 'w');
        if ($fp) {
            foreach ($config as $key => $value) {
                fwrite($fp, "\$config['$key'] = ");
                if ($value == "") $value = "";
                if ($key == 'dirperm' ||$key == 'default_umask') {
                    $value = '0'.decoct($value);
                }
                if (preg_match('|timezone|', $key)) $value = "$value";
                fwrite($fp, var_export($value, true));
                fwrite($fp, ";\n");
            }
            fclose($fp);
            echo 'I tried to draft one based on your old configs. It can be found';
            echo '<font face="Courier New" color=Gray>/tmp/configv2.php.new</font><br/>';
            echo "Here it is printed for you:<br/>\n<pre>\n";
            echo file_get_contents('/tmp/configv2.php.new');
            echo "</pre>\n";
        }
    } else {
        echo ('You must create one based on your old configs (or from scratch).');
    }
    $error = true;
} else {
    echo('<font color=green><strong>PASSED</strong></font> <br/>');
    echo("<h4>- Testing your \$config['temporary_directory'] variable ($temporary_directory)... </h4>");

    // Now start checking the location and perms for $temporary_directory
    // Location vars
    $temporary_directory = $config['temporary_directory'];
    $localpath = realpath('./');
    $temppath = realpath($temporary_directory);

    // For webserver uid/gid info
    $uidisvalid = 0;
    $tmpfname = tempnam("/tmp", "TELAEN-");
    $fd = @fopen($tmpfname, "w");
    if ($fd) {
        if (fwrite($fd, "foo")) {
            fclose($fd);
            // we know the file was created
            $uid = fileowner($tmpfname);
            $gid = filegroup($tmpfname);
            unlink($tmpfname);
            $uidisvalid = 1;
        }
    }

    echo('<h4>- Can we write it?...</h4>');
    if (!is_writable($temporary_directory)) {
        echo('<font color=red><strong>!! FAILED !!</strong></font>
		<br/>The path given in <font face="Courier New" color=Gray>$temporary_directory</font> points to a folder that is not writable<br/>
		The user wich your webserver runs on (apache in *nix or IUSR_name in windows) MUST have rights to create folder and files<br/>
		on this directory. try chmod or Properties dialog<br/>');
        echo("The directory should be mode 700");
        if ($uidisvalid) {
            echo(" with a Owner of $uid and Group of $gid");
        }
        echo(".<br/>");
        $error = true;
    } else {
        // We know it's writable, but how secure is it?
        // Note: If $uidisvalid is 0, then we were not able to
        //       get the web server uid/gid, most likely due to
        //       an open_basedir issue. Since we know $temporary_directory
        //       is writable now, get that info here :)
        if (!$uidisvalid) {
            $tmpfname = tempnam("$temporary_directory", "TELAEN-");
            $fd = @fopen($tmpfname, "w");
            if ($fd) {
                if (fwrite($fd, "foo")) {
                    fclose($fd);
                    // we know the file was created
                    $uid = fileowner($tmpfname);
                    $gid = filegroup($tmpfname);
                    unlink($tmpfname);
                    $uidisvalid = 1;
                }
            }
        }
        $tuid = fileowner($temporary_directory);
        $tgid = filegroup($temporary_directory);
        $mode = substr(sprintf('%o', fileperms($temporary_directory)), -3);

        echo('<font color=green><strong>PASSED</strong></font><br/>');
        echo("Now let's check the permissions.<br/>The directory should be mode 700");
        if ($uidisvalid) {
            echo(" with a Owner of $uid and Group of $gid");
        }
        echo(". Let's see how close you are:<br/>");
        echo("Your mode is $mode, Owner is $tuid and Group is $tgid...   ");
        if ($mode != "700" ||
            ($uidisvalid && (($tuid != $uid) || ($tgid != $gid)))) {
            echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font><br/>Not setup securely!');
            $warn = true;
        } else {
            echo('<font color=green><strong>PASSED</strong></font><br/>');
        }
    }

    echo('<h4>- Is it a safe location?...</h4>');
    if (substr($temppath, 0, strlen($localpath)) == $localpath) {
        echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font>
		<br/>The path given in <font face="Courier New" color=Gray>$temporary_directory</font> points to a folder inside the main folder<br/>
		Eg. main folder is /var/html/telaen and temp folder is /var/html/telaen/tmp<br/>
		There are security issues using this configuration, please choose a non-shared folder to store temporary files<br/>
		/var/telaen is a good choice<br/>');
        $warn = true;
    } else {
        echo('<font color=green><strong>PASSED</strong></font><br/>');
    }

    // Now check to make sure that Smarty is not under here as well.
    $smartyrelative = SMARTY_DIR;
    $smartypathdefined = realpath(SMARTY_DIR);
    $smartypathold = realpath('./smarty/');
    $smartypathnew = realpath('./smarty_move_me/');

    echo("<h4>- Testing your Smarty libs location</strong> (SMARTY_DIR:$smartyrelative -> $smartypathdefined)...</h4>>");
    if (substr($smartypathdefined, 0, strlen($localpath)) == $localpath) {
        echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font>
		<br/>The path given in <font face="Courier New" color=Gray>SMARTY_DIR</font> points to a folder inside the main folder<br/>
		Eg. main folder is /var/html/telaen and temp folder is /var/html/telaen/tmp<br/>
		There are security issues using this configuration, please choose a non-shared folder to store temporary files<br/>
		/var/telaen is a good choice<br/>');
        $warn = true;
    } else {
        echo('<font color=green><strong>PASSED</strong></font><br/>');
    }

    echo("<br/><strong>- Now checking that ./smarty/ is not here as well</strong>... <br/>");
    if (is_readable($smartypathold)) {
        echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font>
		<br/>There is a Smarty libs installation here in your public space. It should be removed!<br/>');
    } else {
        echo('<font color=green><strong>PASSED</strong></font><br/>');
    }

    echo("<br/><strong>- Now checking that ./smarty_move_me/ is not here as well</strong>... <br/>");
    if (is_readable($smartypathnew)) {
        echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font>
		<br/>There is a Smarty libs installation here in your public space. It should be removed!<br/>');
    } else {
        echo('<font color=green><strong>PASSED</strong></font><br/>');
    }
}

$megs8 = 8 * 1024 * 1024;
$megs32 = $megs8 * 4;

$iniLimit = ini_get('memory_limit');
$tempSize = str_replace('K', '*1024', str_replace('M', '*1024*1024', str_replace('G', '*1024*1024*1024', $iniLimit)));

if ($tempSize) {
    eval("\$memoryLimit = $tempSize;");
} else {
    $iniLimit = "Unlimited";
}
echo("<hr><h2>Testing your memory limits</strong> (memory_limit: $iniLimit)</h2>");

if ($tempSize && $memoryLimit < $megs8) {
    echo('<font color=red><strong>!! FAILED !!</strong></font>
	<br/>PHP.ini\'s <font face="Courier New" color=Gray>memory_limit</font> must be at least <code>8M</code> (We recommend 32M (32 MegaBytes)<br/>');
    $error = true;
} elseif ($tempSize && $memoryLimit >= $megs8 && $memoryLimit < $megs32) {
    echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font>
	<br/>PHP.ini\'s <font face="Courier New" color=Gray>memory_limit</font> should be at least 32 (32 MegaBytes), but may still work.<br/>');
    $warn = true;
} else {
    echo('<font color=green><strong>PASSED</strong></font><br/>');
}

echo('<hr><h2>Testing server installation</h2>');


if (ini_get('safe_mode')) {
    echo('<font color=orange><strong>&lt; WARNING &gt;</strong></font>
	<br/>PHP.ini\'s <font face="Courier New" color=Gray>safe_mode</font> is on. You may have problems with this configuration<br/>');
    $warn = true;
} else {
    echo('<font color=green><strong>PASSED</strong></font><br/>');
}

echo('<br/><hr><br/>');
if ($error) {
?>

            <strong><font color="red">
                Your system is not ready to run Telaen.<br/>
                </font>
                <h3>Please fix all <font color="red">!! FAILED !!</font> topics and run this page again</h3>
            </strong></font>
<?php
        } else {
?>
            <strong><font color="#003366">
                Your system appears to be ready to run Telaen.<br/><br/>
<?php
    if ($warn) {
?>
                    There are some <font color="orange">&lt; WARNING &gt;S</font> that should be fixed before you deploy your webmail.<br/>
                    <br/>
<?php
    }
?>

                Before you start using, make sure you've correctly configured your <font face="Courier New">$smtp_server</font><br/>
                variable. If you will use an external SMTP server, please make sure you will not  need a SMTP Authentication. <br/>
                In positive case , use the <font face="Courier New">$use_password_for_smtp</font> variable, otherwise you will<br/>
                receive a "Verify your relay rules" error message while sending mails<br/><br/><br/>
                <h3>To start using your webmail, please delete or rename the <font face="Courier New" color=Gray>extra/check_install.php</font> file AND <a href="../">CLICK HERE TO CONTINUE</a></h3>
                </font></strong></font>
<?php
}
?>
    </body>
</html>
