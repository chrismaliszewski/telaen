<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>... Testing Telaen v2.x installation ...</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
h1 {
	font-family: Verdana, Geneva, sans-serif;
	font-size: 24pt;
	font-style: normal;
	line-height: normal;
	font-weight: bold;
	font-variant: normal;
	color: #3300CC;
}
.fail {
	font-family: "Courier New", Courier, monospace;
	font-size: 16pt;
	font-style: oblique;
	font-weight: bold;
	color: red;
	text-decoration: underline;
}
.codish {
	font-family: "Courier New", Courier, monospace;
	font-size: 14pt;
	color: #666666;
}
.codishsml {
	font-family: "Courier New", Courier, monospace;
	font-size: 11pt;
	color: #666666;
}
.codish2 {
	font-family: "Courier New", Courier, monospace;
	font-size: 11pt;
	color: #666666;
	white-space: pre;
}
h2 {
	font-family: Tahoma, Geneva, sans-serif;
	font-size: 16pt;
	font-style: oblique;
	font-weight: bold;
	color: #0033FF;
}
h4 {
	font-family: Tahoma, Geneva, sans-serif;
	font-size: 14pt;
	font-style: oblique;
	font-weight: bold;
	color: #0033FF;
}
.pass {
	font-family: "Courier New", Courier, monospace;
	color: green;
	font-size: 14pt;
	font-weight: bold;
}
.warn {
	font-family: "Courier New", Courier, monospace;
	font-size: 14pt;
	font-style: italic;
	font-weight: bold;
	color: orange;
}
.Description {
	font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
	font-size: 14pt;
	font-style: normal;
	font-weight: normal;
}
body,td,th {
	font-family: Verdana, Geneva, sans-serif;
	font-size: 14pt;
	color: #000000;
}
.notice {
	font-size: 10pt;
	font-style: italic;
	color: #666666;
}
.closeme {
    font-family: "Courier New", Courier, monospace;
    font-size: 11pt;
	color: #000000;
    text-align:right;
	font-weight: bold;
}
.closeme a:link { text-decoration:none; }
.seeme a:link { font-size: 75%; text-decoration:none; }
.popup {
    left: 100px;
    top: 50px;
	font-family: "Courier New", Courier, monospace;
	font-size: 11pt;
	color: #666666;
	white-space: pre;
	position:absolute;
	border:5px solid #000000;
    padding:20px;
	display: none;
    background-color: #eeeeee;
}
</style>
    </head>
<?php
        ini_set('display_errors', 0);
        error_reporting(E_ALL);
        define('I_AM_TELAEN', 'check_install.php');
        function pout($fp, $value)
        {
            switch (gettype($value)) {
                case 'boolean':
                    fwrite($fp, ($value ? "true" : "false"));
                    break;
                case 'integer':
                case 'double':
                    fwrite($fp, $value);
                    break;
                case 'string':
                    $value = preg_replace("|'|", "\'", $value);
                    fwrite($fp, "'$value'");
                    break;
                case 'array':
                    fwrite($fp, "array(\n");
                    foreach ($value as $a => $b) {
                        fwrite($fp, "   ");
                        pout($fp, $a);
                        fwrite($fp, " => ");
                        pout($fp, $b);
                        fwrite($fp, ",\n");
                    }
                    fwrite($fp, ")");
                    break;
                default:
                    fwrite($fp, "'$value'"); break;
            }
        }
        chdir('../'); // So the include works
?>

    <h1>Intro: Talaen 2.x Installation Check</h1>
    <span class="Description">This script will test your installation and configuration of Telaen v2.x and try to give you a solution if it runs into problems.<br/>

</span>
    <h2>Checking PHP version:</h2>
<?php
        $phpver = phpversion();
        $phpver = doubleval($phpver[0] . '.' . $phpver[2]);
        if ((double) $phpver < 5.4) {
            echo('<span class="fail">!! FAILED !!</span><br/>Talaen requires at least version 5.4.x; you are running {$phpver} <br/>');
            $error = true;
        } else
            echo('<span class="pass">PASSED</span> (Running PHP version ' . phpversion() . ') <br/>');
?>
        <hr>
        <h2 class="Test">Checking for old configuration file(s)</h2>

        <span class="Description">Older versions of Telaen used 3 separate files and a different configuration method.
        Checking if the old configs are still around:</span><br/>

<?php
        $has_old_files = false;
        $old_files = Array();
        foreach (Array("config.languages.php", "config.php", "config.security.php") as $i) {
            if (file_exists('./inc/config/' . $i)) {
                @include "./inc/config/$i";
                $has_old_files = true;
                $old_files[] = $i;
            }
        }
        $oconfig = $GLOBALS;
        unset($oconfig['has_old_files']);
        unset($oconfig['old_files']);
        unset($oconfig['phpver']);

        if ($has_old_files) {
            echo('<span class="warn">&lt; WARNING &gt;</span><br/>I see the following old config files:</br>');
            echo('<span class="codishsml">'); echo("\n");
            foreach ($old_files as $i) {
                echo('&nbsp;&nbsp;&nbsp;&nbsp;' . $i . '<br/>'); echo("\n");
            }
            echo('</span>'); echo("\n");
            echo('<br/>Done<br/>');
             echo('These should be deleted!<br/>');
           $warn = true;
        } else
            echo('<span class="pass">PASSED</span><br/>');
?>
        <hr>
        <h2 class="Test">Checking for old files:</h2>
        <span class="Description">With the upgrade to version 2.x, some files are no longer required and
        should be deleted. Checking for these now:</span><br/>

<?php
        $has_old_files = false;
        $old_files = Array();

        foreach (Array('inc/lib.php', 'langs/bg.txt', 'langs/en_UK.txt', 'langs/is.txt', 'langs/nl.txt', 'langs/ru.txt',
        'langs/ch_big5.txt', 'langs/es.txt', 'langs/it.txt', 'langs/ru_KOI.txt',
        'langs/cz_iso.txt', 'langs/fr.txt', 'langs/ko.txt', 'langs/pl.txt', 'langs/se.txt',
        'langs/de.txt', 'langs/he.txt', 'langs/ms.txt', 'langs/pt_BR.txt', 'langs/th.txt',
        'langs/dk.txt', 'langs/hu.txt', 'langs/nb.txt', 'langs/ro.txt', 'langs/tr.txt') as $i) {
            if (file_exists('./' . $i)) {
                $has_old_files = true;
                $old_files[] = $i;
            }
        }

        if ($has_old_files) {
            echo('<span class="warn">&lt; WARNING &gt;</span><br/>I see the following old files:<br/>');
            echo('<span class="codishsml">'); echo("\n");
            foreach ($old_files as $i) {
                echo('&nbsp;&nbsp;&nbsp;&nbsp;' . $i . '<br/>');
            }
            echo('</span>'); echo("\n");
            echo('<br/>Done<br/>');
            echo('These should be deleted!<br/>');
            $warn = true;
        } else
            echo('<span class="pass">PASSED</span><br/>');
?>
        <hr>
        <h2>Testing inc/config/configv2.php</h2>
        <span class="notice">(if the script stops here, there are parsing problems with your file; try getting a fresh copy and re-editing it)</span><br/>

        <span class="Description">Telaen configuration is located in the </span><span class="codish">./inc/config folder</span><span class="Description"> in </span><span class="codish">configv2.php.default</span><span class="Description"> and
        </span><span class="codish">configv2.php</span><span class="Description">. Checking now:</span><br/>

<?php
$config = array();
@include './inc/config/configv2.php';
if (count($config) == 0) {
    echo('<span class="fail">!! FAILED !!</span><br/>I don\'t see, or cannot read, your <span class="codish">configv2.php</span> file.');
    //
    // Try to create one for them...
    //
    $keep = array('appversion', 'appname', 'themes', 'languages', 'default_theme', 'default_language');
    // $config = array();
    @include './inc/config/configv2.php.default';
    if (count($config) > 0) {
        foreach ($config as $key => $value) {
            if (!in_array($key, $keep))
                $config[$key] = ${$key};
        }
        $config['capa_override']['PIPELINING'] = $mail_use_pipelining;
        $config['capa_override']['ATOP'] = $mail_use_atop;
        $config['capa_override']['UIDL'] = $mail_use_uidl;
        $config['capa_override']['APOP'] = $mail_use_apop;
        $config['SMARTY_DIR'] = SMARTY_DIR;
        $fp = @fopen('/tmp/configv2.php.new', 'w');
        if ($fp) {
            fwrite($fp, "<?php\n");
            fwrite($fp, "/*\n");
            fwrite($fp, " * Auto-created Telaen config file:::\n");
            fwrite($fp, " *    written:".date("D M j G:i:s T Y")."\n");
            fwrite($fp, " *    DO NOT USE WITH DOUBLE AND TRIPLE CHECKING!!\n");
            fwrite($fp, " */\n\n");
            fwrite($fp, "defined('I_AM_TELAEN') or die('Direct access not permitted');\n");
            fwrite($fp, "require('./inc/version.php');\n");
            fwrite($fp, "\$config['appversion'] = \$appversion;\n");
            fwrite($fp, "\$config['appname'] = \$appname;\n");
            fwrite($fp, "@include('./inc/news/news.system.php');\n");
            fwrite($fp, "\$config['systemNews'] = \$systemNews;\n");
            foreach ($config as $key => $value) {
                fwrite($fp, "\$config['$key'] = ");
                if ($value == "") $value = "";
                if ($key == 'dirperm' ||$key == 'default_umask') {
                    $value = '0'.decoct($value);
                }
                if (preg_match('|timezone|', $key)) $value = "$value";
                // pout($fp, $value);
                fwrite($fp, var_export($value, true));
                fwrite($fp, ";\n");
            }
            fclose($fp);
            echo('I tried to draft one based on your old configs. It can be found at:&nbsp;');
            echo('<span class="codish">/tmp/configv2.php.new</span>&nbsp;&nbsp;');
            echo('<span class="seeme"><a href="javascript:void(0)" onclick="document.getElementById(\'pop\').style.display=\'block\'">');
            echo('&lt;see it&gt;</a></span>');
            echo('<br/><div id="pop" class="popup">'); echo("\n");
            echo('<div class="closeme">');
            echo('<a href="javascript:void(0)" onclick="document.getElementById(\'pop\').style.display=\'none\'">[X]</a>');
            echo('</div><br/>');
            echo("\n<br/>\n");
            $show =  file('/tmp/configv2.php.new');
            foreach ($show as $line) {
                echo htmlspecialchars($line);
            }
            echo("</div>\n");
        }
    } else {
        echo ('You must create one based on your old configs (or from scratch).');
    }
    $error = true;
} else {
    echo('<span class="pass">PASSED</span> <br/>');
    $temporary_directory = $config['temporary_directory'];
    echo("<h4>- Testing your \$config['temporary_directory'] variable: $temporary_directory... </h4>");

    // Now start checking the location and perms for $temporary_directory
    // Location vars
    $localpath = realpath('./');
    $temppath = realpath($temporary_directory);

    // For webserver uid/gid info
    $uidisvalid = 0;
    $tmpfname = tempnam("/tmp", "TELAEN-");
    $fd = @fopen($tmpfname, "w");
    if ($fd) {
        if (fwrite($fd, "foo")) {
            fclose($fd);
            // we know the file was created
            $uid = fileowner($tmpfname);
            $gid = filegroup($tmpfname);
            unlink($tmpfname);
            $uidisvalid = 1;
        }
    }

    echo('<h4>- Can we write it?...</h4>');
    if (!is_writable($temporary_directory)) {
        echo('<span class="fail">!! FAILED !!</span>
		<br/>The path given in <span class="codish">$temporary_directory</span> points to a folder that is not writable<br/>
		The user wich your webserver runs on (apache in *nix or IUSR_name in windows) MUST have rights to create folder and files<br/>
		on this directory. Try <span class="codish">chmod</span> or Properties dialog<br/>');
        echo("The directory should be mode 700");
        if ($uidisvalid) {
            echo(" with a Owner of $uid and Group of $gid");
        }
        echo(".<br/>");
        $error = true;
    } else {
        // We know it's writable, but how secure is it?
        // Note: If $uidisvalid is 0, then we were not able to
        //       get the web server uid/gid, most likely due to
        //       an open_basedir issue. Since we know $temporary_directory
        //       is writable now, get that info here :)
        if (!$uidisvalid) {
            $tmpfname = tempnam("$temporary_directory", "TELAEN-");
            $fd = @fopen($tmpfname, "w");
            if ($fd) {
                if (fwrite($fd, "foo")) {
                    fclose($fd);
                    // we know the file was created
                    $uid = fileowner($tmpfname);
                    $gid = filegroup($tmpfname);
                    unlink($tmpfname);
                    $uidisvalid = 1;
                }
            }
        }
        $tuid = fileowner($temporary_directory);
        $tgid = filegroup($temporary_directory);
        $mode = substr(sprintf('%o', fileperms($temporary_directory)), -3);

        echo('<span class="pass">PASSED</span><br/>');
        echo("Now let's check the permissions.<br/>The directory should be mode 700");
        if ($uidisvalid) {
            echo(" with a Owner of $uid and Group of $gid");
        }
        echo(". Let's see how close you are:<br/>");
        echo("Your mode is $mode, Owner is $tuid and Group is $tgid...   ");
        if ($mode != "700" ||
            ($uidisvalid && (($tuid != $uid) || ($tgid != $gid)))) {
            echo('<span class="warn">&lt; WARNING &gt;</span><br/>Not setup securely!');
            $warn = true;
        } else {
            echo('<span class="pass">PASSED</span><br/>');
        }
    }

    echo('<h4>- Is it a safe location?...</h4>');
    if (substr($temppath, 0, strlen($localpath)) == $localpath) {
        echo('<span class="warn">&lt; WARNING &gt;</span>
		<br/>The path given in $temporary_directory points to a folder inside the main folder<br/>
		Eg. main folder is /var/html/telaen and temp folder is /var/html/telaen/tmp<br/>
		There are security issues using this configuration, please choose a non-shared folder to store temporary files<br/>
		/var/telaen is a good choice<br/>');
        $warn = true;
    } else {
        echo('<span class="pass">PASSED</span><br/>');
    }

    // Now check to make sure that Smarty is not under here as well.
    $smartyrelative = SMARTY_DIR;
    $smartypathdefined = realpath(SMARTY_DIR);
    $smartypathold = realpath('./smarty/');
    $smartypathnew = realpath('./smarty_move_me/');

    echo("<h4>- Testing your Smarty libs location (SMARTY_DIR:$smartyrelative -> $smartypathdefined)...</h4>>");
    if (substr($smartypathdefined, 0, strlen($localpath)) == $localpath) {
        echo('<span class="warn">&lt; WARNING &gt;</span>
		<br/>The path given in SMARTY_DIR points to a folder inside the main folder<br/>
		Eg. main folder is /var/html/telaen and temp folder is /var/html/telaen/tmp<br/>
		There are security issues using this configuration, please choose a non-shared folder to store temporary files<br/>
		/var/telaen is a good choice<br/>');
        $warn = true;
    } else {
        echo('<span class="pass">PASSED</span><br/>');
    }

    echo("<br/><strong>- Now checking that ./smarty/ is not here as well</strong>... <br/>");
    if (is_readable($smartypathold)) {
        echo('<span class="warn">&lt; WARNING &gt;</span>
		<br/>There is a Smarty libs installation here in your public space. It should be removed!<br/>');
    } else {
        echo('<span class="pass">PASSED</span><br/>');
    }

    echo("<br/><strong>- Now checking that ./smarty_move_me/ is not here as well</strong>... <br/>");
    if (is_readable($smartypathnew)) {
        echo('<span class="warn">&lt; WARNING &gt;</span>
		<br/>There is a Smarty libs installation here in your public space. It should be removed!<br/>');
    } else {
        echo('<span class="pass">PASSED</span><br/>');
    }
}

$megs8 = 8 * 1024 * 1024;
$megs32 = $megs8 * 4;

$iniLimit = ini_get('memory_limit');
$tempSize = str_replace('K', '*1024', str_replace('M', '*1024*1024', str_replace('G', '*1024*1024*1024', $iniLimit)));

if ($tempSize) {
    eval("\$memoryLimit = $tempSize;");
} else {
    $iniLimit = "Unlimited";
}
echo("<hr><h2>Testing your memory limits (memory_limit: $iniLimit)</h2>");

if ($tempSize && $memoryLimit < $megs8) {
    echo('<span class="fail">!! FAILED !!</span>
	<br/>PHP.ini\'s memory_limit</font> must be at least <code>8M</code> (We recommend 32M (32 MegaBytes)<br/>');
    $error = true;
} elseif ($tempSize && $memoryLimit >= $megs8 && $memoryLimit < $megs32) {
    echo('<span class="warn">&lt; WARNING &gt;</span>
	<br/>PHP.ini\'s memory_limit</font> should be at least 32 (32 MegaBytes), but may still work.<br/>');
    $warn = true;
} else {
    echo('<span class="pass">PASSED</span><br/>');
}

echo('<hr><h2>Testing server installation</h2>');


if (ini_get('safe_mode')) {
    echo('<span class="warn">&lt; WARNING &gt;</span>
	<br/>PHP.ini\'s safe_mode is on. You may have problems with this configuration<br/>');
    $warn = true;
} else {
    echo('<span class="pass">PASSED</span><br/>');
}

echo('<br/><hr><br/>');
if ($error) {
?>

                Your system is not ready to run Telaen.<br>
                <h3>Please fix all <span class="fail">!! FAILED !!</span> topics and run this page again</h3>
<?php
        } else {
?>
                Your system appears to be ready to run Telaen.<br><br>
<?php
    if ($warn) {
?>
                    There are some <span class="warn">&lt; WARNINGS &gt;</span> that should be fixed before you deploy your webmail.<br/>
                    <br/>
<?php
    }
?>

                Before you start using, make sure you've correctly configured your <span class="codish">$smtp_server</span><br/>
                variable. If you will use an external SMTP server, please make sure you will not  need a SMTP Authentication. <br/>
                In positive case , use the <span class="codish">$use_password_for_smtp</span> variable, otherwise you will<br/>
                receive a "Verify your relay rules" error message while sending mails<br/><br/><br/>
                <h3>To start using your webmail, please delete or rename the <span class="codish">extra/check_install.php</span> file AND <a href="../">CLICK HERE TO CONTINUE</a></h3>
<?php
}
?>
    </body>
</html>
